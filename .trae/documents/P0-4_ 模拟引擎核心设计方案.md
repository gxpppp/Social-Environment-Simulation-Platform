## P0-4: 模拟引擎核心 - 多智能体协调逻辑

### 功能需求

#### 1. 模拟引擎架构
- **SimulationEngine** - 核心引擎类
- **AgentManager** - Agent状态管理
- **EventManager** - 事件处理系统
- **NetworkManager** - 社交网络管理
- **TickScheduler** - 时间步调度器

#### 2. Agent决策循环
每个Tick执行的决策流程：
1. **感知阶段** - 获取环境信息和邻居状态
2. **决策阶段** - 基于人格特质和知识背景做决策
3. **行动阶段** - 执行决策（发表观点/互动/沉默）
4. **更新阶段** - 更新自身状态和关系

#### 3. 事件系统
- **外部事件** - 政策发布、突发事件
- **内部事件** - Agent间互动、观点传播
- **事件传播** - 基于网络结构的传播机制

#### 4. 社交网络动态
- **关系建立** - 基于相似性和互动频率
- **关系衰减** - 长期不互动导致关系弱化
- **影响力计算** - 基于网络位置和人格特质

#### 5. 状态管理
- **全局状态** - 支持率、反对率、中立率
- **Agent状态** - 观点、情绪、记忆
- **网络状态** - 连接密度、聚类系数

### 技术实现方案

#### 后端服务扩展
```
modules/
├── simulation-engine/
│   ├── simulation-engine.module.ts
│   ├── simulation-engine.service.ts
│   ├── agent-manager.service.ts
│   ├── event-manager.service.ts
│   ├── network-manager.service.ts
│   └── tick-scheduler.service.ts
```

#### 核心算法

1. **Agent决策算法**
```typescript
async function makeDecision(agent: Agent, context: Context): Promise<Decision> {
  // 1. 感知环境
  const perception = await perceiveEnvironment(agent, context);
  
  // 2. 调用LLM生成决策
  const prompt = buildDecisionPrompt(agent, perception);
  const response = await llmService.generate(prompt);
  
  // 3. 解析决策
  const decision = parseDecision(response);
  
  // 4. 应用人格修正
  return applyPersonalityModifier(decision, agent.personality);
}
```

2. **观点传播算法**
```typescript
function propagateOpinion(
  source: Agent, 
  target: Agent, 
  opinion: Opinion
): number {
  // 计算影响强度
  const influence = calculateInfluence(source, target);
  
  // 计算接受概率
  const acceptance = calculateAcceptance(target, opinion);
  
  // 计算观点变化
  const change = influence * acceptance * OPINION_CHANGE_RATE;
  
  return change;
}
```

3. **网络演化算法**
```typescript
function evolveNetwork(agents: Agent[], interactions: Interaction[]): void {
  // 强化现有关系
  for (const interaction of interactions) {
    strengthenRelationship(interaction.source, interaction.target);
  }
  
  // 建立新关系
  for (const agent of agents) {
    const potentialFriends = findPotentialFriends(agent, agents);
    for (const friend of potentialFriends) {
      if (shouldConnect(agent, friend)) {
        createRelationship(agent, friend);
      }
    }
  }
  
  // 衰减弱关系
  for (const agent of agents) {
    decayWeakRelationships(agent);
  }
}
```

### 数据结构

```typescript
interface SimulationState {
  sessionId: string;
  currentTick: number;
  totalTicks: number;
  status: 'running' | 'paused' | 'stopped' | 'completed';
  
  // 全局指标
  metrics: {
    supportRate: number;
    opposeRate: number;
    neutralRate: number;
    networkDensity: number;
    activityLevel: number;
  };
  
  // Agent状态
  agentStates: Map<string, AgentState>;
  
  // 网络状态
  networkState: {
    edges: Array<{ source: string; target: string; weight: number }>;
    clusters: Array<string[]>;
  };
  
  // 事件日志
  events: SimulationEvent[];
}

interface AgentState {
  agentId: string;
  opinion: number;        // -1 到 1
  emotion: number;        // -1 到 1
  activity: number;       // 0 到 1
  connections: string[];  // 连接的其他Agent
  memory: AgentMemory[];  // 近期记忆
}

interface SimulationEvent {
  tick: number;
  timestamp: Date;
  type: 'opinion_change' | 'interaction' | 'external_event';
  data: any;
}
```

### WebSocket实时通信

```typescript
// 广播模拟状态
broadcastStatus(sessionId: string, status: SimulationState) {
  this.gateway.broadcastStatus(sessionId, {
    tick: status.currentTick,
    metrics: status.metrics,
    agentStates: Array.from(status.agentStates.values()),
  });
}

// 广播Agent事件
broadcastAgentEvent(sessionId: string, event: AgentEvent) {
  this.gateway.broadcastAgentEvent(sessionId, event);
}
```

### 性能优化

1. **批处理** - 批量处理Agent决策
2. **缓存** - 缓存LLM响应和计算结果
3. **异步** - 异步执行非关键操作
4. **限流** - 限制LLM调用频率

### 前端集成

1. **实时数据展示** - WebSocket接收并展示
2. **控制面板** - 开始/暂停/停止模拟
3. **可视化** - 网络图、时间轴、指标仪表盘

请确认此设计方案后，我将立即开始实现代码。