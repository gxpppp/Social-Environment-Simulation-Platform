# 社会环境模拟平台 - 架构设计

## 1. 架构设计总览

### 1.1 设计原则

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          架构设计核心原则                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │   高内聚      │  │   低耦合      │  │   可扩展      │  │   高性能      │     │
│  │  High        │  │   Low        │  │  Scalable    │  │  High        │     │
│  │  Cohesion    │  │  Coupling    │  │              │  │  Performance │     │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘     │
│                                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │   高可用      │  │   安全性      │  │   可观测      │  │   可维护      │     │
│  │  High        │  │   Security   │  │  Observable  │  │  Maintainable│     │
│  │  Availability│  │              │  │              │  │              │     │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 技术选型决策矩阵

| 技术领域 | 选型方案 | 备选方案 | 选型理由 |
|---------|---------|---------|---------|
| **前端框架** | React 18 + TypeScript | Vue3, Angular | 生态丰富、类型安全、组件化成熟 |
| **状态管理** | Zustand + React Query | Redux, MobX | 轻量级、TypeScript友好、异步处理优秀 |
| **UI组件库** | Ant Design 5.x | Material-UI, Chakra | 企业级设计、中文支持好、组件丰富 |
| **可视化引擎** | D3.js + ECharts + Cytoscape.js | Three.js, Sigma.js | 2D/3D图表、网络图、性能优秀 |
| **后端框架** | NestJS 10.x | Express, Fastify | 模块化、TypeScript原生、企业级架构 |
| **API协议** | GraphQL + REST Hybrid | gRPC, WebSocket | 灵活查询、实时通信、渐进式采用 |
| **数据库-关系型** | PostgreSQL 16 | MySQL 8, Oracle | JSON支持、扩展性强、开源免费 |
| **数据库-图数据库** | Neo4j 5.x | ArangoDB, JanusGraph | 关系建模优秀、Cypher查询、生态成熟 |
| **缓存/消息** | Redis 7.x Cluster | Memcached, RabbitMQ | 高性能缓存、Pub/Sub、Stream支持 |
| **搜索引擎** | Elasticsearch 8.x | OpenSearch, Solr | 全文检索、聚合分析、实时索引 |
| **容器编排** | Kubernetes 1.28 | Docker Swarm, Nomad | 行业标准、自动扩缩容、服务网格 |
| **服务网格** | Istio 1.19 | Linkerd, Consul | 流量管理、安全策略、可观测性 |
| **监控告警** | Prometheus + Grafana | Datadog, NewRelic | 云原生标准、开源免费、社区活跃 |
| **日志收集** | ELK Stack (8.x) | Loki, Fluentd | 全文检索、可视化、告警集成 |
| **链路追踪** | Jaeger | Zipkin, Tempo | OpenTelemetry兼容、性能开销低 |
| **LLM集成** | Silicon Flow API | OpenAI, Anthropic | 国产模型、成本优势、合规性 |

---

## 2. 系统整体架构

### 2.1 分层架构图

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              客户端层 (Client Layer)                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌───────────┐  │
│  │   Web端      │  │   桌面端     │  │   移动端     │  │   API客户端  │  │  第三方集成 │  │
│  │  (React)    │  │  (Electron) │  │ (React Native)│  │  (SDK/CLI)  │  │  (Webhook) │  │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘  └───────────┘  │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              网关层 (Gateway Layer)                                  │
│  ┌───────────────────────────────────────────────────────────────────────────────┐  │
│  │                         API Gateway (Kong / Traefik)                          │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │  │
│  │  │  认证授权    │  │  限流熔断    │  │  路由转发    │  │  协议转换 (REST/GraphQL)│  │  │
│  │  │ Auth/JWT    │  │ Rate Limit  │  │   Routing   │  │    Protocol Conv.   │  │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              应用层 (Application Layer)                              │
│                                                                                      │
│  ┌─────────────────────────┐  ┌─────────────────────────┐  ┌─────────────────────┐  │
│  │     用户服务 (User)      │  │    角色服务 (Agent)      │  │   场景服务 (Scene)   │  │
│  │  ┌─────────────────┐   │  │  ┌─────────────────┐   │  │  ┌───────────────┐   │  │
│  │  │  用户管理        │   │  │  │  AI角色CRUD      │   │  │  │ 场景模板管理    │   │  │
│  │  │  权限控制        │   │  │  │  属性配置        │   │  │  │ 环境参数设置    │   │  │
│  │  │  组织管理        │   │  │  │  模型绑定        │   │  │  │ 规则引擎        │   │  │
│  │  └─────────────────┘   │  │  └─────────────────┘   │  │  └───────────────┘   │  │
│  └─────────────────────────┘  └─────────────────────────┘  └─────────────────────┘  │
│                                                                                      │
│  ┌─────────────────────────┐  ┌─────────────────────────┐  ┌─────────────────────┐  │
│  │     模拟服务 (Simulation)│  │    分析服务 (Analytics)  │  │   可视化服务 (Viz)  │  │
│  │  ┌─────────────────┐   │  │  ┌─────────────────┐   │  │  │  ┌─────────────┐  │  │
│  │  │  多智能体协调    │   │  │  │  预测分析        │   │  │  │  │ 2D/3D渲染    │  │  │
│  │  │  事件处理引擎    │   │  │  │  模式识别        │   │  │  │  │ 实时数据流   │  │  │
│  │  │  状态管理        │   │  │  │  报告生成        │   │  │  │  │ 交互式图表   │  │  │
│  │  └─────────────────┘   │  │  └─────────────────┘   │  │  │  └─────────────┘  │  │
│  └─────────────────────────┘  └─────────────────────────┘  └─────────────────────┘  │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              领域层 (Domain Layer)                                   │
│                                                                                      │
│  ┌───────────────────────────────────────────────────────────────────────────────┐  │
│  │                         核心领域服务 (Core Domain Services)                    │  │
│  │                                                                                │  │
│  │   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐   │  │
│  │   │  Agent领域  │    │  Event领域  │    │ Society领域 │    │  Model领域  │   │  │
│  │   │             │    │             │    │             │    │             │   │  │
│  │   │ • 角色建模   │    │ • 事件定义   │    │ • 群体动力学 │    │ • LLM调用   │   │  │
│  │   │ • 行为决策   │    │ • 传播机制   │    │ • 网络分析   │    │ • 提示管理   │   │  │
│  │   │ • 记忆管理   │    │ • 影响评估   │    │ • 演化模拟   │    │ • 响应解析   │   │  │
│  │   └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘   │  │
│  │                                                                                │  │
│  └───────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              基础设施层 (Infrastructure Layer)                       │
│                                                                                      │
│  ┌─────────────────────────┐  ┌─────────────────────────┐  ┌─────────────────────┐  │
│  │     数据持久化           │  │    消息与缓存            │  │   外部服务集成       │  │
│  │  ┌─────────────────┐   │  │  ┌─────────────────┐   │  │  ┌───────────────┐   │  │
│  │  │ PostgreSQL      │   │  │  │ Redis Cluster   │   │  │  │ Silicon Flow  │   │  │
│  │  │ (主数据库)       │   │  │  │ (缓存/消息)      │   │  │  │ LLM API       │   │  │
│  │  ├─────────────────┤   │  │  ├─────────────────┤   │  │  ├───────────────┤   │  │
│  │  │ Neo4j           │   │  │  │ Kafka/RabbitMQ  │   │  │  │ 文件存储服务   │   │  │
│  │  │ (图数据库)       │   │  │  │ (消息队列)       │   │  │  │ (OSS/S3)      │   │  │
│  │  ├─────────────────┤   │  │  ├─────────────────┤   │  │  ├───────────────┤   │  │
│  │  │ Elasticsearch   │   │  │  │ MinIO           │   │  │  │ 邮件/短信服务  │   │  │
│  │  │ (搜索引擎)       │   │  │  │ (对象存储)       │   │  │  │               │   │  │
│  │  └─────────────────┘   │  │  └─────────────────┘   │  │  └───────────────┘   │  │
│  └─────────────────────────┘  └─────────────────────────┘  └─────────────────────┘  │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 微服务划分

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           微服务架构拓扑图                                            │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│                              ┌──────────────┐                                       │
│                              │  API Gateway │                                       │
│                              │   (Kong)     │                                       │
│                              └──────┬───────┘                                       │
│                                     │                                                │
│           ┌─────────────────────────┼─────────────────────────┐                      │
│           │                         │                         │                      │
│           ▼                         ▼                         ▼                      │
│    ┌─────────────┐           ┌─────────────┐           ┌─────────────┐              │
│    │  User       │◄─────────►│  Agent      │◄─────────►│  Scene      │              │
│    │  Service    │           │  Service    │           │  Service    │              │
│    │  (用户服务)  │           │  (角色服务)  │           │  (场景服务)  │              │
│    └──────┬──────┘           └──────┬──────┘           └──────┬──────┘              │
│           │                         │                         │                      │
│           │    ┌────────────────────┼────────────────────┐    │                      │
│           │    │                    │                    │    │                      │
│           ▼    ▼                    ▼                    ▼    ▼                      │
│    ┌─────────────┐           ┌─────────────┐           ┌─────────────┐              │
│    │ Simulation  │◄─────────►│  Analytics  │◄─────────►│  Viz        │              │
│    │  Service    │           │  Service    │           │  Service    │              │
│    │  (模拟服务)  │           │  (分析服务)  │           │  (可视化服务)│              │
│    └──────┬──────┘           └──────┬──────┘           └──────┬──────┘              │
│           │                         │                         │                      │
│           │    ┌────────────────────┼────────────────────┐    │                      │
│           │    │                    │                    │    │                      │
│           ▼    ▼                    ▼                    ▼    ▼                      │
│    ┌─────────────┐           ┌─────────────┐           ┌─────────────┐              │
│    │  Event      │◄─────────►│  Model      │◄─────────►│  Notify     │              │
│    │  Service    │           │  Service    │           │  Service    │              │
│    │  (事件服务)  │           │  (模型服务)  │           │  (通知服务)  │              │
│    └─────────────┘           └─────────────┘           └─────────────┘              │
│                                                                                      │
│  ═════════════════════════════════════════════════════════════════════════════════  │
│                              共享基础设施 (Shared Infrastructure)                     │
│                                                                                      │
│    ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│    │  Config     │  │  Discovery  │  │  Message    │  │  Observability│             │
│    │  Center     │  │  Service    │  │  Broker     │  │  Platform     │             │
│    │ (Apollo)    │  │ (Consul)    │  │ (RabbitMQ)  │  │ (Prometheus)  │             │
│    └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘              │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 2.3 服务间通信模式

| 通信模式 | 使用场景 | 技术实现 | 特点 |
|---------|---------|---------|------|
| **同步HTTP/REST** | 简单查询、实时响应 | OpenFeign + LoadBalancer | 简单直观、易于调试 |
| **同步gRPC** | 高性能内部通信 | gRPC + Protocol Buffers | 二进制传输、强类型、高性能 |
| **异步消息队列** | 事件驱动、解耦处理 | RabbitMQ / Kafka | 削峰填谷、最终一致性 |
| **发布/订阅** | 广播通知、状态同步 | Redis Pub/Sub | 轻量级、实时性好 |
| **WebSocket** | 实时推送、双向通信 | Socket.io / WS | 全双工、低延迟 |

---

## 3. 前端架构设计

### 3.1 前端技术栈架构

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              前端架构分层图                                          │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  ┌───────────────────────────────────────────────────────────────────────────────┐  │
│  │                              展示层 (Presentation Layer)                       │  │
│  │                                                                                │  │
│  │   ┌────────────────────────────────────────────────────────────────────────┐  │  │
│  │   │                        页面组件 (Page Components)                       │  │  │
│  │   │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────────┐  │  │  │
│  │   │  │ 工作台    │ │ 场景编辑器│ │ 模拟控制台│ │ 分析面板  │ │ 系统管理      │  │  │  │
│  │   │  │Dashboard │ │  Editor  │ │Simulator │ │Analytics │ │   Admin      │  │  │  │
│  │   │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────────┘  │  │  │
│  │   └────────────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                                │  │
│  │   ┌────────────────────────────────────────────────────────────────────────┐  │  │
│  │   │                        业务组件 (Business Components)                   │  │  │
│  │   │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────────┐  │  │  │
│  │   │  │Agent卡片 │ │ 网络图谱  │ │ 时间轴    │ │ 数据面板  │ │ 配置表单      │  │  │  │
│  │   │  │AgentCard │ │NetworkGraph│ │Timeline │ │DataPanel │ │ ConfigForm   │  │  │  │
│  │   │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────────┘  │  │  │
│  │   └────────────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                                │  │
│  │   ┌────────────────────────────────────────────────────────────────────────┐  │  │
│  │   │                        基础组件 (Base Components)                       │  │  │
│  │   │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────────┐  │  │  │
│  │   │  │  按钮     │ │  输入框   │ │  下拉框   │ │  模态框   │ │  数据表格     │  │  │  │
│  │   │  │  Button  │ │  Input   │ │  Select  │ │  Modal   │ │    Table     │  │  │  │
│  │   │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────────┘  │  │  │
│  │   └────────────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                                │  │
│  └───────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                      │
│  ┌───────────────────────────────────────────────────────────────────────────────┐  │
│  │                              逻辑层 (Logic Layer)                              │  │
│  │                                                                                │  │
│  │   ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐              │  │
│  │   │   状态管理       │  │   业务逻辑       │  │   服务调用       │              │  │
│  │   │  State Mgmt     │  │  Business Logic │  │  API Services   │              │  │
│  │   │                 │  │                 │  │                 │              │  │
│  │   │ • Zustand Store │  │ • Custom Hooks  │  │ • React Query   │              │  │
│  │   │ • Context API   │  │ • Utils         │  │ • Axios Client  │              │  │
│  │   │ • Persist Middleware│ • Validators │  │ • Error Handler │              │  │
│  │   └─────────────────┘  └─────────────────┘  └─────────────────┘              │  │
│  │                                                                                │  │
│  └───────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                      │
│  ┌───────────────────────────────────────────────────────────────────────────────┐  │
│  │                              基础设施层 (Infrastructure Layer)                  │  │
│  │                                                                                │  │
│  │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │  │
│  │   │  可视化引擎  │  │  网络请求    │  │  工具库      │  │      构建工具        │  │
│  │   │  D3.js      │  │  Axios      │  │  Lodash     │  │     Vite 5.x        │  │
│  │   │  ECharts    │  │  GraphQL    │  │  Day.js     │  │     TypeScript      │  │
│  │   │  Cytoscape  │  │  WebSocket  │  │  UUID       │  │     ESLint/Prettier │  │
│  │   └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────────┘  │  │
│  │                                                                                │  │
│  └───────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 前端项目结构

```
frontend/
├── apps/
│   ├── web/                          # Web应用主入口
│   │   ├── src/
│   │   │   ├── main.tsx              # 应用入口
│   │   │   ├── App.tsx               # 根组件
│   │   │   ├── routes/               # 路由配置
│   │   │   ├── layouts/              # 布局组件
│   │   │   └── styles/               # 全局样式
│   │   ├── index.html
│   │   └── package.json
│   │
│   └── desktop/                      # Electron桌面应用
│       ├── src/
│       ├── electron-main/            # 主进程
│       └── package.json
│
├── packages/
│   ├── ui/                           # 共享UI组件库
│   │   ├── src/
│   │   │   ├── components/           # 基础组件
│   │   │   ├── business/             # 业务组件
│   │   │   ├── visualization/        # 可视化组件
│   │   │   └── theme/                # 主题配置
│   │   └── package.json
│   │
│   ├── core/                         # 核心逻辑库
│   │   ├── src/
│   │   │   ├── api/                  # API客户端
│   │   │   ├── state/                # 状态管理
│   │   │   ├── hooks/                # 自定义Hooks
│   │   │   └── utils/                # 工具函数
│   │   └── package.json
│   │
│   ├── visualization/                # 可视化引擎
│   │   ├── src/
│   │   │   ├── network/              # 网络图渲染
│   │   │   ├── charts/               # 图表组件
│   │   │   ├── timeline/             # 时间轴组件
│   │   │   └── three/                # 3D可视化
│   │   └── package.json
│   │
│   └── types/                        # 共享类型定义
│       ├── src/
│       │   ├── api.ts                # API类型
│       │   ├── models.ts             # 数据模型
│       │   └── enums.ts              # 枚举定义
│       └── package.json
│
├── turbo.json                        # Monorepo配置
└── pnpm-workspace.yaml               # 工作区配置
```

### 3.3 状态管理架构

```typescript
// 核心状态分层设计

// ============================================
// Layer 1: 全局应用状态 (App State)
// ============================================
interface AppState {
  // 用户会话
  auth: {
    user: User | null;
    token: string | null;
    permissions: string[];
  };
  
  // 应用配置
  config: {
    theme: 'light' | 'dark';
    language: 'zh-CN' | 'en-US';
    sidebarCollapsed: boolean;
  };
  
  // 全局UI状态
  ui: {
    notifications: Notification[];
    modals: ModalState[];
    loading: boolean;
  };
}

// ============================================
// Layer 2: 领域状态 (Domain State)
// ============================================
interface AgentDomainState {
  // AI角色列表
  agents: {
    items: AIAgent[];
    selectedId: string | null;
    filters: AgentFilter;
    pagination: PaginationState;
  };
  
  // 角色详情
  agentDetail: {
    data: AIAgent | null;
    attributes: AgentAttributes | null;
    memory: MemorySnapshot | null;
  };
  
  // 角色模板
  templates: {
    items: AgentTemplate[];
    categories: string[];
  };
}

interface SceneDomainState {
  // 场景列表
  scenes: {
    items: Scene[];
    selectedId: string | null;
  };
  
  // 当前场景
  currentScene: {
    config: SceneConfig | null;
    agents: SceneAgent[];
    environment: EnvironmentParams;
    rules: RuleConfig[];
  };
}

interface SimulationDomainState {
  // 模拟会话
  session: {
    id: string | null;
    status: SimulationStatus;
    progress: number;
    currentTick: number;
  };
  
  // 实时数据
  realtime: {
    events: SimulationEvent[];
    agentStates: AgentStateSnapshot[];
    metrics: SimulationMetrics;
  };
  
  // 历史记录
  history: {
    snapshots: WorldSnapshot[];
    selectedTick: number;
  };
}

// ============================================
// Layer 3: 服务端状态 (Server State)
// ============================================
// 使用 React Query 管理
const serverStateHooks = {
  // AI角色API
  useAgents: (filters: AgentFilter) => useQuery({...}),
  useAgentDetail: (id: string) => useQuery({...}),
  useCreateAgent: () => useMutation({...}),
  useUpdateAgent: () => useMutation({...}),
  
  // 场景API
  useScenes: () => useQuery({...}),
  useSceneDetail: (id: string) => useQuery({...}),
  
  // 模拟API
  useSimulationSession: (id: string) => useQuery({...}),
  useStartSimulation: () => useMutation({...}),
  useSimulationEvents: (sessionId: string) => useQuery({...}),
};
```

---

## 4. 后端架构设计

### 4.1 后端分层架构

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              后端架构分层图 (NestJS)                                  │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  ┌───────────────────────────────────────────────────────────────────────────────┐  │
│  │                              接口层 (Interface Layer)                          │  │
│  │                                                                                │  │
│  │   ┌────────────────────────────────────────────────────────────────────────┐  │  │
│  │   │                           Controllers (REST/GraphQL)                    │  │  │
│  │   │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐  │  │  │
│  │   │  │ AgentController│ │SceneController│ │SimulationController│ │AnalyticsController│  │  │  │
│  │   │  │   @Controller  │ │   @Controller  │ │   @Controller      │ │   @Controller      │  │  │  │
│  │   │  │   /api/agents  │ │   /api/scenes  │ │   /api/simulations │ │   /api/analytics   │  │  │  │
│  │   │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────┘  │  │  │
│  │   │                                                                               │  │  │
│  │   │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐  │  │  │
│  │   │  │  DTOs       │ │  Validators │ │  Guards     │ │  Interceptors   │  │  │  │
│  │   │  │ (Data Transfer│ │ (Class-Valid)│ │ (Auth/Role) │ │ (Transform/Log) │  │  │  │
│  │   │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────┘  │  │  │
│  │   └────────────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                                │  │
│  └───────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                      │
│  ┌───────────────────────────────────────────────────────────────────────────────┐  │
│  │                              应用层 (Application Layer)                        │  │
│  │                                                                                │  │
│  │   ┌────────────────────────────────────────────────────────────────────────┐  │  │
│  │   │                              Services                                   │  │  │
│  │   │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐  │  │  │
│  │   │  │ AgentService │ │SceneService │ │SimulationService│ │AnalyticsService │  │  │  │
│  │   │  │   @Injectable │ │   @Injectable │ │   @Injectable   │ │   @Injectable   │  │  │  │
│  │   │  │   业务逻辑    │ │   场景管理    │ │   模拟协调      │ │   分析计算      │  │  │  │
│  │   │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────┘  │  │  │
│  │   │                                                                               │  │  │
│  │   │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐  │  │  │
│  │   │  │ EventService │ │ModelService │ │NotifyService  │ │ReportService    │  │  │  │
│  │   │  │   事件处理    │ │   模型调用    │ │   通知推送      │ │   报告生成      │  │  │  │
│  │   │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────┘  │  │  │
│  │   └────────────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                                │  │
│  └───────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                      │
│  ┌───────────────────────────────────────────────────────────────────────────────┐  │
│  │                              领域层 (Domain Layer)                             │  │
│  │                                                                                │  │
│  │   ┌────────────────────────────────────────────────────────────────────────┐  │  │
│  │   │                           Domain Services                               │  │  │
│  │   │  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────────────┐  │  │  │
│  │   │  │  AgentDomainService│ │EventDomainService│ │SocietyDomainService     │  │  │  │
│  │   │  │  • 角色建模        │ │ • 事件传播       │ │ • 群体动力学             │  │  │  │
│  │   │  │  • 行为决策        │ │ • 影响计算       │ │ • 网络演化               │  │  │  │
│  │   │  │  • 记忆管理        │ │ • 级联效应       │ │ • 社会计算               │  │  │  │
│  │   │  └─────────────────┘ └─────────────────┘ └─────────────────────────┘  │  │  │
│  │   │                                                                               │  │  │
│  │   │  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────────────┐  │  │  │
│  │   │  │  ModelDomainService│ │MemoryDomainService│ │CoordinationDomainService│  │  │  │
│  │   │  │  • LLM调用       │ │ • 记忆存储       │ │ • 多智能体协调           │  │  │  │
│  │   │  │  • 提示工程       │ │ • 记忆检索       │ │ • 冲突解决               │  │  │  │
│  │   │  │  • 响应解析       │ │ • 记忆压缩       │ │ • 资源调度               │  │  │  │
│  │   │  └─────────────────┘ └─────────────────┘ └─────────────────────────┘  │  │  │
│  │   └────────────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                                │  │
│  └───────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                      │
│  ┌───────────────────────────────────────────────────────────────────────────────┐  │
│  │                              基础设施层 (Infrastructure Layer)                  │  │
│  │                                                                                │  │
│  │   ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────────────────┐  │  │
│  │   │   Repositories   │ │   External APIs  │ │   Message Queue             │  │  │
│  │   │  (TypeORM/Neo4j) │ │  (Silicon Flow)  │ │  (RabbitMQ/Redis)           │  │  │
│  │   │                  │ │                  │ │                             │  │  │
│  │   │ • PostgreSQL    │ │ • LLM Client    │ │ • Event Bus                 │  │  │
│  │   │ • Neo4j Driver  │ │ • Rate Limiter  │ │ • Job Queue                 │  │  │
│  │   │ • Redis Client  │ │ • Cache Layer   │ │ • Pub/Sub                   │  │  │
│  │   └─────────────────┘ └─────────────────┘ └─────────────────────────────┘  │  │
│  │                                                                                │  │
│  └───────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 后端项目结构

```
backend/
├── apps/
│   ├── api-gateway/                  # API网关服务
│   │   ├── src/
│   │   │   ├── main.ts
│   │   │   ├── app.module.ts
│   │   │   ├── guards/
│   │   │   ├── interceptors/
│   │   │   └── middleware/
│   │   └── Dockerfile
│   │
│   ├── user-service/                 # 用户服务
│   │   ├── src/
│   │   │   ├── user/
│   │   │   │   ├── user.controller.ts
│   │   │   │   ├── user.service.ts
│   │   │   │   ├── user.module.ts
│   │   │   │   ├── dto/
│   │   │   │   └── entities/
│   │   │   └── main.ts
│   │   └── Dockerfile
│   │
│   ├── agent-service/                # AI角色服务
│   │   ├── src/
│   │   │   ├── agent/
│   │   │   ├── template/
│   │   │   ├── attribute/
│   │   │   └── main.ts
│   │   └── Dockerfile
│   │
│   ├── scene-service/                # 场景服务
│   │   ├── src/
│   │   │   ├── scene/
│   │   │   ├── environment/
│   │   │   └── main.ts
│   │   └── Dockerfile
│   │
│   ├── simulation-service/           # 模拟服务 (核心)
│   │   ├── src/
│   │   │   ├── simulation/
│   │   │   ├── coordination/         # 多智能体协调
│   │   │   ├── event-engine/         # 事件引擎
│   │   │   ├── state-manager/        # 状态管理
│   │   │   └── main.ts
│   │   └── Dockerfile
│   │
│   ├── analytics-service/            # 分析服务
│   │   ├── src/
│   │   │   ├── analytics/
│   │   │   ├── prediction/
│   │   │   ├── reporting/
│   │   │   └── main.ts
│   │   └── Dockerfile
│   │
│   ├── model-service/                # 模型服务
│   │   ├── src/
│   │   │   ├── model/
│   │   │   ├── prompt/
│   │   │   ├── silicon-flow/         # Silicon Flow集成
│   │   │   └── main.ts
│   │   └── Dockerfile
│   │
│   └── event-service/                # 事件服务
│       ├── src/
│       │   ├── event/
│       │   ├── event-bus/
│       │   └── main.ts
│       └── Dockerfile
│
├── libs/
│   ├── shared/                       # 共享库
│   │   ├── src/
│   │   │   ├── decorators/
│   │   │   ├── filters/
│   │   │   ├── interceptors/
│   │   │   ├── pipes/
│   │   │   └── utils/
│   │   └── package.json
│   │
│   ├── domain/                       # 领域模型库
│   │   ├── src/
│   │   │   ├── agent/
│   │   │   ├── event/
│   │   │   ├── society/
│   │   │   └── model/
│   │   └── package.json
│   │
│   ├── infrastructure/               # 基础设施库
│   │   ├── src/
│   │   │   ├── database/
│   │   │   ├── cache/
│   │   │   ├── message-queue/
│   │   │   └── external-api/
│   │   └── package.json
│   │
│   └── types/                        # 类型定义库
│       ├── src/
│       │   ├── api.types.ts
│       │   ├── domain.types.ts
│       │   └── dto.types.ts
│       └── package.json
│
├── docker-compose.yml
├── nest-cli.json
└── package.json
```

### 4.3 核心领域服务实现

```typescript
// ============================================
// Agent Domain Service - AI角色领域服务
// ============================================
@Injectable()
export class AgentDomainService {
  constructor(
    private readonly llmClient: LLMClient,
    private readonly memoryService: MemoryService,
    private readonly attributeCalculator: AttributeCalculator,
  ) {}

  /**
   * 生成AI角色的决策
   */
  async generateDecision(
    agent: AIAgent,
    context: DecisionContext,
  ): Promise<AgentDecision> {
    // 1. 检索相关记忆
    const relevantMemories = await this.memoryService.retrieveRelevant(
      agent.id,
      context.situation,
      { limit: 10 },
    );

    // 2. 构建决策提示
    const prompt = this.buildDecisionPrompt(agent, context, relevantMemories);

    // 3. 调用LLM生成决策
    const response = await this.llmClient.generate({
      model: agent.modelConfig.modelId,
      prompt,
      temperature: agent.modelConfig.temperature,
      maxTokens: agent.modelConfig.maxTokens,
    });

    // 4. 解析并验证决策
    const decision = this.parseDecision(response);

    // 5. 存储决策到记忆
    await this.memoryService.store(agent.id, {
      type: MemoryType.DECISION,
      content: decision,
      context: context.situation,
    });

    return decision;
  }

  /**
   * 更新角色属性（基于经验和环境反馈）
   */
  async updateAttributes(
    agent: AIAgent,
    experiences: Experience[],
  ): Promise<AttributeDelta> {
    const delta = this.attributeCalculator.computeDelta(
      agent.attributes,
      experiences,
    );

    // 应用属性变化（考虑可塑性限制）
    const updatedAttributes = this.applyAttributeDelta(
      agent.attributes,
      delta,
      agent.traits.plasticity,
    );

    return { delta, updatedAttributes };
  }
}

// ============================================
// Coordination Domain Service - 多智能体协调服务
// ============================================
@Injectable()
export class CoordinationDomainService {
  constructor(
    private readonly agentDomainService: AgentDomainService,
    private readonly eventBus: EventBus,
  ) {}

  /**
   * 执行一轮多智能体交互
   */
  async executeInteractionRound(
    session: SimulationSession,
    agents: AIAgent[],
  ): Promise<InteractionRoundResult> {
    const interactions: AgentInteraction[] = [];
    const agentDecisions = new Map<string, AgentDecision>();

    // 1. 并行收集所有Agent的决策
    const decisionPromises = agents.map(async (agent) => {
      const context = await this.buildDecisionContext(agent, session);
      const decision = await this.agentDomainService.generateDecision(
        agent,
        context,
      );
      agentDecisions.set(agent.id, decision);
      return { agent, decision };
    });

    await Promise.all(decisionPromises);

    // 2. 解析交互意图并匹配
    for (const [agentId, decision] of agentDecisions) {
      if (decision.intent.type === InteractionType.COMMUNICATE) {
        const targetId = decision.intent.targetId;
        const targetDecision = agentDecisions.get(targetId);

        if (targetDecision) {
          // 创建双向交互
          const interaction = await this.resolveInteraction(
            agents.find((a) => a.id === agentId)!,
            agents.find((a) => a.id === targetId)!,
            decision,
            targetDecision,
          );
          interactions.push(interaction);
        }
      }
    }

    // 3. 广播交互事件
    for (const interaction of interactions) {
      this.eventBus.publish(new AgentInteractionEvent(interaction));
    }

    return { interactions, agentDecisions };
  }

  /**
   * 解决智能体间的交互
   */
  private async resolveInteraction(
    agentA: AIAgent,
    agentB: AIAgent,
    decisionA: AgentDecision,
    decisionB: AgentDecision,
  ): Promise<AgentInteraction> {
    // 计算关系影响
    const relationshipImpact = this.calculateRelationshipImpact(
      agentA,
      agentB,
      decisionA,
      decisionB,
    );

    // 生成交互结果
    const outcome = await this.generateInteractionOutcome(
      agentA,
      agentB,
      decisionA,
      decisionB,
    );

    return {
      participants: [agentA.id, agentB.id],
      type: InteractionType.DIALOGUE,
      content: outcome.dialogue,
      relationshipChange: relationshipImpact,
      timestamp: new Date(),
    };
  }
}

// ============================================
// Society Domain Service - 社会动力学服务
// ============================================
@Injectable()
export class SocietyDomainService {
  constructor(
    private readonly graphService: GraphService,
    private readonly networkAnalyzer: NetworkAnalyzer,
  ) {}

  /**
   * 计算社会网络指标
   */
  async calculateNetworkMetrics(
    societyId: string,
  ): Promise<NetworkMetrics> {
    const graph = await this.graphService.getSocietyGraph(societyId);

    return {
      // 密度：实际连接数 / 可能的最大连接数
      density: this.networkAnalyzer.calculateDensity(graph),

      // 中心性指标
      centrality: {
        degree: this.networkAnalyzer.degreeCentrality(graph),
        betweenness: this.networkAnalyzer.betweennessCentrality(graph),
        closeness: this.networkAnalyzer.closenessCentrality(graph),
        eigenvector: this.networkAnalyzer.eigenvectorCentrality(graph),
      },

      // 聚类系数
      clusteringCoefficient:
        this.networkAnalyzer.averageClusteringCoefficient(graph),

      // 社区检测
      communities: this.networkAnalyzer.detectCommunities(graph),

      // 小世界特性
      smallWorldSigma: this.networkAnalyzer.calculateSmallWorldSigma(graph),
    };
  }

  /**
   * 模拟观点演化
   */
  async simulateOpinionEvolution(
    societyId: string,
    topic: string,
    ticks: number,
  ): Promise<OpinionEvolutionResult> {
    const snapshots: OpinionSnapshot[] = [];
    let currentOpinions = await this.getInitialOpinions(societyId, topic);

    for (let tick = 0; tick < ticks; tick++) {
      // 应用DeGroot模型或Hegselmann-Krause模型
      currentOpinions = this.applyOpinionDynamics(
        currentOpinions,
        await this.getSocialNetwork(societyId),
        {
          model: 'hegselmann_krause',
          confidenceBound: 0.3,
          influenceWeight: 0.5,
        },
      );

      snapshots.push({
        tick,
        distribution: this.calculateOpinionDistribution(currentOpinions),
        polarization: this.calculatePolarization(currentOpinions),
        consensus: this.calculateConsensus(currentOpinions),
      });
    }

    return { snapshots, finalOpinions: currentOpinions };
  }
}
```

---

## 5. 数据流设计

### 5.1 核心业务流程数据流

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          模拟执行流程数据流图                                         │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│   用户操作                    前端                      后端                      数据库/缓存
│      │                        │                          │                          │
│      │  1.创建场景              │                          │                          │
│      │───────────────────────>│                          │                          │
│      │                        │  2.POST /api/scenes      │                          │
│      │                        │─────────────────────────>│                          │
│      │                        │                          │  3.验证并存储场景配置      │
│      │                        │                          │─────────────────────────>│
│      │                        │                          │  4.返回场景ID             │
│      │                        │  5.场景创建成功           │<─────────────────────────│
│      │  6.显示场景编辑器        │<─────────────────────────│                          │
│      │<───────────────────────│                          │                          │
│      │                        │                          │                          │
│      │  7.配置AI角色            │                          │                          │
│      │───────────────────────>│                          │                          │
│      │                        │  8.POST /api/agents      │                          │
│      │                        │  (批量创建)               │                          │
│      │                        │─────────────────────────>│                          │
│      │                        │                          │  9.调用Silicon Flow      │
│      │                        │                          │  生成角色属性              │
│      │                        │                          │<──────┐                  │
│      │                        │                          │       │ LLM API          │
│      │                        │                          │───────┘                  │
│      │                        │                          │  10.存储角色数据          │
│      │                        │                          │─────────────────────────>│
│      │                        │  11.返回角色列表          │<─────────────────────────│
│      │  12.显示角色配置完成     │<─────────────────────────│                          │
│      │<───────────────────────│                          │                          │
│      │                        │                          │                          │
│      │  13.启动模拟             │                          │                          │
│      │───────────────────────>│                          │                          │
│      │                        │  14.POST /api/simulations │                          │
│      │                        │  /start                  │                          │
│      │                        │─────────────────────────>│                          │
│      │                        │                          │  15.创建模拟会话          │
│      │                        │                          │  初始化状态机             │
│      │                        │                          │                          │
│      │                        │                          │  ╔═══════════════════════╗ │
│      │                        │                          │  ║   模拟执行引擎循环     ║ │
│      │                        │                          │  ║                       ║ │
│      │                        │                          │  ║  16.加载Agent状态     ║ │
│      │                        │                          │  ║  17.生成决策(prompt)  ║ │
│      │                        │                          │  ║  18.调用LLM并行处理   ║ │<─┐
│      │                        │                          │  ║  19.解析响应          ║ │  │
│      │                        │                          │  ║  20.执行交互          ║ │  │
│      │                        │                          │  ║  21.更新状态          ║ │  │
│      │                        │                          │  ║  22.持久化快照        ║─┘  │
│      │                        │                          │  ║  23.发布事件          ║────┤
│      │                        │                          │  ╚═══════════════════════╝    │
│      │                        │                          │                               │
│      │                        │  24.WebSocket推送        │                               │
│      │                        │  实时事件流              │<──────────────────────────────│
│      │  25.实时更新可视化      │<─────────────────────────│                               │
│      │<═══════════════════════│                          │                               │
│      │                        │                          │                               │
│      │  26.请求分析结果         │                          │                               │
│      │───────────────────────>│                          │                               │
│      │                        │  27.GET /api/analytics   │                               │
│      │                        │  /{simulationId}         │                               │
│      │                        │─────────────────────────>│                               │
│      │                        │                          │  28.聚合分析数据            │
│      │                        │                          │  (从时序数据库)              │
│      │                        │                          │<──────────────────────────────│
│      │                        │  29.返回分析报告          │                               │
│      │  30.展示分析结果         │<─────────────────────────│                               │
│      │<───────────────────────│                          │                               │
│      │                        │                          │                               │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 事件驱动架构

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          事件驱动架构图                                              │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│   ┌───────────────────────────────────────────────────────────────────────────────┐  │
│   │                           事件总线 (Event Bus)                                 │  │
│   │                      RabbitMQ / Redis Streams                                 │  │
│   │                                                                                │  │
│   │   Exchange: simulation.events                                                  │  │
│   │                                                                                │  │
│   │   ┌─────────────────┬─────────────────┬─────────────────┬─────────────────┐   │  │
│   │   │  agent.decision │ agent.interact  │  world.update   │  system.alert   │   │  │
│   │   │     (Direct)    │    (Direct)     │    (Topic)      │    (Fanout)     │   │  │
│   │   └────────┬────────┴────────┬────────┴────────┬────────┴────────┬────────┘   │  │
│   │            │                 │                 │                 │            │  │
│   └────────────┼─────────────────┼─────────────────┼─────────────────┼────────────┘  │
│                │                 │                 │                 │               │
│                ▼                 ▼                 ▼                 ▼               │
│   ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐   │
│   │  决策处理器      │ │  交互处理器      │ │  状态更新处理器  │ │  告警处理器      │   │
│   │ DecisionHandler │ │InteractHandler  │ │  StateHandler   │ │  AlertHandler   │   │
│   │                 │ │                 │ │                 │ │                 │   │
│   │ • 决策记录      │ │ • 关系更新      │ │ • 指标计算      │ │ • 阈值检查      │   │
│   │ • 记忆存储      │ │ • 情感分析      │ │ • 快照生成      │ │ • 通知发送      │   │
│   │ • 行为分析      │ │ • 网络演化      │ │ • 历史归档      │ │ • 日志记录      │   │
│   └────────┬────────┘ └────────┬────────┘ └────────┬────────┘ └─────────────────┘   │
│            │                 │                 │                                    │
│            ▼                 ▼                 ▼                                    │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                         数据存储层                                           │   │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │   │
│   │  │ PostgreSQL  │  │   Neo4j     │  │ TimescaleDB │  │   Elasticsearch     │ │   │
│   │  │  (业务数据)  │  │  (关系图谱)  │  │ (时序数据)   │  │    (日志/搜索)       │ │   │
│   │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────────┘ │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│   ═════════════════════════════════════════════════════════════════════════════════  │
│   事件类型定义：                                                                      │
│                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │  AgentDecisionEvent     { agentId, decision, context, timestamp }           │   │
│   │  AgentInteractionEvent  { participants, type, content, outcome, timestamp } │   │
│   │  WorldStateUpdateEvent  { tick, snapshot, metrics, timestamp }              │   │
│   │  SimulationAlertEvent   { level, type, message, data, timestamp }           │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 可扩展性设计

### 6.1 水平扩展架构

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          水平扩展架构图                                              │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│                              ┌─────────────────────┐                                 │
│                              │   Load Balancer     │                                 │
│                              │   (Nginx/HAProxy)   │                                 │
│                              └──────────┬──────────┘                                 │
│                                         │                                            │
│                    ┌────────────────────┼────────────────────┐                       │
│                    │                    │                    │                       │
│                    ▼                    ▼                    ▼                       │
│           ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐               │
│           │  API Gateway    │ │  API Gateway    │ │  API Gateway    │               │
│           │   Instance 1    │ │   Instance 2    │ │   Instance N    │               │
│           └────────┬────────┘ └────────┬────────┘ └────────┬────────┘               │
│                    │                    │                    │                       │
│                    └────────────────────┼────────────────────┘                       │
│                                         │                                            │
│                    ┌────────────────────┼────────────────────┐                       │
│                    │                    │                    │                       │
│           ┌────────▼────────┐  ┌────────▼────────┐  ┌────────▼────────┐              │
│           │                 │  │                 │  │                 │              │
│           │  Service Mesh   │  │  Service Mesh   │  │  Service Mesh   │              │
│           │   (Istio)       │  │   (Istio)       │  │   (Istio)       │              │
│           │                 │  │                 │  │                 │              │
│           │  ┌───────────┐  │  │  ┌───────────┐  │  │  ┌───────────┐  │              │
│           │  │Agent Svc  │  │  │  │Agent Svc  │  │  │  │Agent Svc  │  │              │
│           │  │  Pod 1    │  │  │  │  Pod 2    │  │  │  │  Pod N    │  │              │
│           │  └───────────┘  │  │  └───────────┘  │  │  └───────────┘  │              │
│           │  ┌───────────┐  │  │  ┌───────────┐  │  │  ┌───────────┐  │              │
│           │  │Sim Svc    │  │  │  │Sim Svc    │  │  │  │Sim Svc    │  │              │
│           │  │  Pod 1    │  │  │  │  Pod 2    │  │  │  │  Pod N    │  │              │
│           │  └───────────┘  │  │  └───────────┘  │  │  └───────────┘  │              │
│           │  ┌───────────┐  │  │  ┌───────────┐  │  │  ┌───────────┐  │              │
│           │  │Model Svc  │  │  │  │Model Svc  │  │  │  │Model Svc  │  │              │
│           │  │  Pod 1    │  │  │  │  Pod 2    │  │  │  │  Pod N    │  │              │
│           │  └───────────┘  │  │  └───────────┘  │  │  └───────────┘  │              │
│           │                 │  │                 │  │                 │              │
│           └─────────────────┘  └─────────────────┘  └─────────────────┘              │
│                                                                                      │
│   ═════════════════════════════════════════════════════════════════════════════════  │
│   自动扩缩容策略 (HPA - Horizontal Pod Autoscaler):                                   │
│                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │  Agent Service:   CPU > 70% 或 内存 > 80% 时扩容，最小3副本，最大20副本      │   │
│   │  Simulation Svc:  活动会话数 > 100/实例 时扩容，最小2副本，最大50副本         │   │
│   │  Model Service:   API调用队列 > 500 时扩容，最小3副本，最大100副本            │   │
│   │  Analytics Svc:   分析任务队列 > 50 时扩容，最小2副本，最大10副本             │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 数据库分片策略

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          数据库分片架构                                              │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│   PostgreSQL 分片策略 (按租户ID + 时间范围):                                         │
│                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                             │   │
│   │   Shard 1 (tenant_1-100, 2024)    Shard 2 (tenant_1-100, 2025)              │   │
│   │   ┌─────────────────────────┐    ┌─────────────────────────┐                │   │
│   │   │  users, agents, scenes  │    │  users, agents, scenes  │                │   │
│   │   │  simulation_logs        │    │  simulation_logs        │                │   │
│   │   │  events (2024)          │    │  events (2025)          │                │   │
│   │   └─────────────────────────┘    └─────────────────────────┘                │   │
│   │                                                                             │   │
│   │   Shard 3 (tenant_101-200, 2024)  Shard 4 (tenant_101-200, 2025)             │   │
│   │   ┌─────────────────────────┐    ┌─────────────────────────┐                │   │
│   │   │  users, agents, scenes  │    │  users, agents, scenes  │                │   │
│   │   │  simulation_logs        │    │  simulation_logs        │                │   │
│   │   │  events (2024)          │    │  events (2025)          │                │   │
│   │   └─────────────────────────┘    └─────────────────────────┘                │   │
│   │                                                                             │   │
│   │   [Citus Coordinator Node]                                                  │   │
│   │        │                                                                    │   │
│   │        └── 路由查询到对应分片                                                  │   │
│   │                                                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│   Neo4j 集群架构 (因果集群):                                                         │
│                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                             │   │
│   │                    ┌─────────────────┐                                      │   │
│   │                    │  Leader (Core)  │  ← 写入操作、集群协调                  │   │
│   │                    │   (3 cores)     │                                      │   │
│   │                    └────────┬────────┘                                      │   │
│   │                             │                                               │   │
│   │           ┌─────────────────┼─────────────────┐                             │   │
│   │           │                 │                 │                             │   │
│   │           ▼                 ▼                 ▼                             │   │
│   │    ┌─────────────┐   ┌─────────────┐   ┌─────────────┐                      │   │
│   │    │ Follower 1  │   │ Follower 2  │   │  Read Replica│  ← 读取操作、图查询   │   │
│   │    │   (Core)    │   │   (Core)    │   │   (多个)     │                      │   │
│   │    └─────────────┘   └─────────────┘   └─────────────┘                      │   │
│   │                                                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│   TimescaleDB 超表分区 (按时间自动分区):                                             │
│                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                             │   │
│   │   超表: agent_states, world_snapshots, interaction_logs                     │   │
│   │                                                                             │   │
│   │   分区策略: 按时间范围 (1天/分区) + 按场景ID哈希                               │   │
│   │                                                                             │   │
│   │   chunk_2024_01_01_sceneA    chunk_2024_01_01_sceneB    ...                 │   │
│   │   chunk_2024_01_02_sceneA    chunk_2024_01_02_sceneB    ...                 │   │
│   │   ...                                                                             │   │
│   │                                                                             │   │
│   │   自动数据保留策略: 原始数据保留30天，聚合数据保留1年，归档数据保留5年          │   │
│   │                                                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. 安全架构设计

### 7.1 安全分层架构

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          安全架构图                                                  │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│   Layer 1: 网络安全                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │  • WAF (Web应用防火墙) - 防护SQL注入、XSS、CSRF等攻击                          │   │
│   │  • DDoS防护 - 流量清洗、速率限制                                               │   │
│   │  • VPC隔离 - 私有网络、安全组规则                                              │   │
│   │  • TLS 1.3 - 全链路加密传输                                                    │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                         │                                            │
│   Layer 2: 认证授权                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │  • JWT Token - 无状态认证，支持RS256签名                                       │   │
│   │  • OAuth 2.0 / OIDC - 第三方登录集成                                           │   │
│   │  • RBAC - 基于角色的访问控制                                                   │   │
│   │  • ABAC - 基于属性的细粒度授权 (数据级)                                         │   │
│   │  • MFA - 多因素认证 (企业版)                                                   │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                         │                                            │
│   Layer 3: API安全                                                                   │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │  • API Gateway - 统一入口、认证、限流                                          │   │
│   │  • Rate Limiting - 请求频率限制 (1000 req/min/用户)                            │   │
│   │  • Input Validation - 请求参数校验、 sanitization                              │   │
│   │  • API Versioning - 版本控制，向后兼容                                         │   │
│   │  • Audit Logging - API调用审计日志                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                         │                                            │
│   Layer 4: 数据安全                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │  • Encryption at Rest - AES-256数据加密                                        │   │
│   │  • Field-level Encryption - 敏感字段加密 (PII)                                 │   │
│   │  • Data Masking - 数据脱敏 (日志、展示)                                        │   │
│   │  • Backup Encryption - 备份加密                                                │   │
│   │  • Data Retention - 数据保留策略，自动清理                                     │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                         │                                            │
│   Layer 5: 应用安全                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │  • Dependency Scanning - 依赖漏洞扫描 (Snyk/Dependabot)                        │   │
│   │  • SAST - 静态应用安全测试                                                     │   │
│   │  • DAST - 动态应用安全测试                                                     │   │
│   │  • Secret Management - 密钥管理 (Vault)                                        │   │
│   │  • Container Security - 镜像扫描、运行时防护                                    │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 数据流加密方案

```typescript
// 敏感数据加密方案

// ============================================
// 1. 传输层加密 (TLS 1.3)
// ============================================
// 所有服务间通信使用mTLS (双向TLS认证)

// ============================================
// 2. 存储层加密
// ============================================
interface EncryptionConfig {
  // 数据库字段级加密
  fieldEncryption: {
    algorithm: 'AES-256-GCM';
    keyManagement: 'AWS KMS' | 'HashiCorp Vault' | 'Azure Key Vault';
    fields: [
      'users.email',
      'users.phone',
      'agents.memory.privateThoughts',
      'scenarios.config.sensitiveParams',
    ];
  };

  // 备份加密
  backupEncryption: {
    enabled: true;
    algorithm: 'AES-256-CBC';
    keyRotation: '90 days';
  };
}

// ============================================
// 3. 应用层加密示例
// ============================================
@Injectable()
export class EncryptionService {
  constructor(
    private readonly vaultClient: VaultClient,
    private readonly configService: ConfigService,
  ) {}

  async encryptField(plainText: string, context: EncryptionContext): Promise<string> {
    // 从Vault获取数据加密密钥 (DEK)
    const dek = await this.vaultClient.getDataKey(context.entityType);
    
    // 使用AES-256-GCM加密
    const iv = crypto.randomBytes(16);
    const cipher = crypto.createCipheriv('aes-256-gcm', dek.key, iv);
    
    let encrypted = cipher.update(plainText, 'utf8', 'hex');
    encrypted += cipher.final('hex');
    
    const authTag = cipher.getAuthTag();
    
    // 返回: keyVersion:iv:authTag:ciphertext
    return `${dek.version}:${iv.toString('hex')}:${authTag.toString('hex')}:${encrypted}`;
  }

  async decryptField(encryptedData: string, context: EncryptionContext): Promise<string> {
    const [keyVersion, ivHex, authTagHex, cipherText] = encryptedData.split(':');
    
    // 获取对应版本的密钥
    const dek = await this.vaultClient.getDataKey(context.entityType, keyVersion);
    
    const iv = Buffer.from(ivHex, 'hex');
    const authTag = Buffer.from(authTagHex, 'hex');
    
    const decipher = crypto.createDecipheriv('aes-256-gcm', dek.key, iv);
    decipher.setAuthTag(authTag);
    
    let decrypted = decipher.update(cipherText, 'hex', 'utf8');
    decrypted += decipher.final('utf8');
    
    return decrypted;
  }
}

// ============================================
// 4. API密钥管理 (Silicon Flow API)
// ============================================
@Injectable()
export class ApiKeyManager {
  constructor(private readonly vault: VaultService) {}

  async getSiliconFlowCredentials(userId: string): Promise<APICredentials> {
    // 优先使用用户自己的API Key
    const userKey = await this.vault.read(`secret/users/${userId}/silicon-flow`);
    
    if (userKey) {
      return {
        apiKey: userKey.data.api_key,
        tier: 'user',
        rateLimit: this.getUserRateLimit(userId),
      };
    }
    
    // 使用平台共享Key (带用量限制)
    const sharedKey = await this.vault.read('secret/platform/silicon-flow');
    return {
      apiKey: sharedKey.data.api_key,
      tier: 'shared',
      rateLimit: { requestsPerMinute: 60, requestsPerDay: 1000 },
    };
  }

  async rotateApiKey(keyId: string): Promise<void> {
    // 生成新Key
    const newKey = await this.generateNewKey();
    
    // 在Vault中更新
    await this.vault.update(keyId, { api_key: newKey });
    
    // 通知相关服务刷新缓存
    await this.notifyKeyRotation(keyId);
  }
}
```

---

## 8. 可观测性架构

### 8.1 监控体系架构

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                          可观测性架构图                                              │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│   数据采集层                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                             │   │
│   │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐   │   │
│   │   │  Metrics    │  │    Logs     │  │   Traces    │  │    Profiles     │   │   │
│   │   │   (指标)     │  │   (日志)     │  │   (链路)     │  │   (性能分析)     │   │   │
│   │   │             │  │             │  │             │  │                 │   │   │
│   │   │ Prometheus  │  │ Fluent Bit  │  │ OpenTelemetry│  │  Pyroscope      │   │   │
│   │   │ Client Libs │  │  Filebeat   │  │    SDK      │  │  (Continuous    │   │   │
│   │   │  Micrometer │  │   Logstash  │  │   Jaeger    │  │   Profiling)    │   │   │
│   │   └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └────────┬────────┘   │   │
│   │          │                │                │                  │            │   │
│   └──────────┼────────────────┼────────────────┼──────────────────┼────────────┘   │
│              │                │                │                  │                 │
│              ▼                ▼                ▼                  ▼                 │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                         数据存储层                                           │   │
│   │                                                                             │   │
│   │   ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────────┐ │   │
│   │   │   Prometheus    │  │   Loki/ELK      │  │          Tempo/Jaeger       │ │   │
│   │   │   (TSDB)        │  │   (Log Store)   │  │        (Trace Store)        │ │   │
│   │   │                 │  │                 │  │                             │ │   │
│   │   │ • 指标时序存储   │  │ • 日志全文索引   │  │ • 链路Span存储              │ │   │
│   │   │ • 告警规则评估   │  │ • 结构化解析     │  │ • 服务依赖分析              │ │   │
│   │   │ • 数据保留15天   │  │ • 保留30天       │  │ • 保留7天                   │ │   │
│   │   └─────────────────┘  └─────────────────┘  └─────────────────────────────┘ │   │
│   │                                                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                         │                                            │
│                                         ▼                                            │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                         可视化与告警层                                       │   │
│   │                                                                             │   │
│   │   ┌─────────────────────────────────────────────────────────────────────┐   │   │
│   │   │                         Grafana                                    │   │   │
│   │   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────┐ │   │   │
│   │   │  │  Dashboard  │  │   Alerts    │  │   Explore   │  │   Logs     │ │   │   │
│   │   │  │   (仪表板)   │  │   (告警)     │  │   (探索)     │  │   (日志)    │ │   │   │
│   │   │  │             │  │             │  │             │  │            │ │   │   │
│   │   │  │ • 业务指标   │  │ • 阈值告警   │  │ • 即席查询   │  │ • 日志检索  │ │   │   │
│   │   │  │ • 系统指标   │  │ • 异常检测   │  │ • 链路追踪   │  │ • 模式分析  │ │   │   │
│   │   │  │ • 自定义面板 │  │ • 多渠道通知 │  │ • 关联分析   │  │ • 实时 tail │ │   │   │
│   │   │  └─────────────┘  └─────────────┘  └─────────────┘  └────────────┘ │   │   │
│   │   └─────────────────────────────────────────────────────────────────────┘   │   │
│   │                                                                             │   │
│   │   ┌─────────────────────────────────────────────────────────────────────┐   │   │
│   │   │                      告警通知渠道                                  │   │   │
│   │   │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐  │   │   │
│   │   │  │  Email   │ │  Slack   │ │  Webhook │ │  PagerDuty│ │  SMS     │  │   │   │
│   │   │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘  │   │   │
│   │   └─────────────────────────────────────────────────────────────────────┘   │   │
│   │                                                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 8.2 关键监控指标

| 类别 | 指标名称 | 说明 | 告警阈值 |
|------|---------|------|---------|
| **业务指标** | simulation.active_sessions | 活跃模拟会话数 | > 1000 |
| | simulation.agents_total | 运行的AI Agent总数 | > 10000 |
| | simulation.events_per_second | 事件处理速率 | 正常范围: 100-5000 |
| | api.requests_per_minute | API请求量 | 异常波动 > 50% |
| | api.error_rate | API错误率 | > 1% |
| | api.latency_p99 | API P99延迟 | > 2000ms |
| **系统指标** | cpu.usage_percent | CPU使用率 | > 80% |
| | memory.usage_percent | 内存使用率 | > 85% |
| | disk.usage_percent | 磁盘使用率 | > 80% |
| | network.io_bytes | 网络IO | 根据基线 |
| **数据库指标** | db.connections_active | 活跃连接数 | > 80% 最大连接 |
| | db.query_duration_p95 | 查询P95耗时 | > 100ms |
| | db.lock_wait_time | 锁等待时间 | > 50ms |
| | cache.hit_rate | 缓存命中率 | < 80% |
| **LLM指标** | llm.requests_per_minute | LLM请求量 | 监控趋势 |
| | llm.latency_average | 平均响应时间 | > 5000ms |
| | llm.error_rate | 调用错误率 | > 5% |
| | llm.tokens_per_request | 平均Token消耗 | 监控成本 |

---

## 9. 技术实现优先级

### 9.1 P0 - 核心架构 (MVP必需)

| 组件 | 技术选型 | 工作量 | 依赖 |
|------|---------|--------|------|
| 前端框架 | React 18 + TypeScript | 2周 | 无 |
| UI组件库 | Ant Design 5.x | 1周 | React |
| 后端框架 | NestJS 10.x | 2周 | Node.js 20 |
| 主数据库 | PostgreSQL 16 | 1周 | 无 |
| 图数据库 | Neo4j 5.x | 1周 | 无 |
| 缓存 | Redis 7.x | 3天 | 无 |
| API网关 | Kong | 3天 | 无 |
| LLM集成 | Silicon Flow API | 1周 | 外部服务 |
| 容器化 | Docker + Compose | 3天 | 无 |

### 9.2 P1 - 增强功能 (Phase 2)

| 组件 | 技术选型 | 工作量 | 依赖 |
|------|---------|--------|------|
| 可视化引擎 | D3.js + ECharts | 2周 | 前端框架 |
| 时序数据库 | TimescaleDB | 1周 | PostgreSQL |
| 消息队列 | RabbitMQ | 1周 | 无 |
| 搜索引擎 | Elasticsearch 8.x | 1周 | 无 |
| 监控体系 | Prometheus + Grafana | 1周 | 无 |
| 日志收集 | ELK Stack | 1周 | 无 |
| 链路追踪 | Jaeger | 3天 | 无 |
| 服务网格 | Istio | 2周 | Kubernetes |

### 9.3 P2 - 高级特性 (Phase 3)

| 组件 | 技术选型 | 工作量 | 依赖 |
|------|---------|--------|------|
| Kubernetes编排 | K8s 1.28 | 2周 | 容器化基础 |
| 自动扩缩容 | HPA + VPA | 1周 | K8s |
| 数据库分片 | Citus | 2周 | PostgreSQL |
| 异地多活 | 多集群部署 | 3周 | K8s |
| 高级安全 | Vault + WAF | 2周 | 基础安全 |
| AI辅助分析 | 自定义模型 | 4周 | LLM基础 |
| 3D可视化 | Three.js | 3周 | 可视化基础 |

---

## 10. 架构决策记录 (ADR)

### ADR-001: 采用微服务架构

**状态**: 已接受

**背景**: 平台需要支持多租户、高并发模拟、独立扩展不同功能模块。

**决策**: 采用微服务架构，按业务领域划分服务。

**后果**:
- ✅ 独立部署和扩展
- ✅ 技术栈灵活性
- ✅ 故障隔离
- ❌ 分布式复杂性
- ❌ 运维成本增加

### ADR-002: 采用NestJS作为后端框架

**状态**: 已接受

**背景**: 需要TypeScript原生支持、模块化架构、企业级特性。

**决策**: 采用NestJS，利用其依赖注入、模块化、装饰器等特性。

**后果**:
- ✅ 代码结构清晰
- ✅ 生态丰富
- ✅ 易于测试
- ❌ 学习曲线
- ❌ 相比Express更重

### ADR-003: 采用PostgreSQL + Neo4j双数据库

**状态**: 已接受

**背景**: 需要同时支持结构化数据和复杂关系建模。

**决策**: PostgreSQL存储业务数据，Neo4j存储Agent关系网络。

**后果**:
- ✅ 各数据库发挥优势
- ✅ 关系查询性能优秀
- ❌ 数据一致性挑战
- ❌ 运维复杂度增加

### ADR-004: 采用React + Zustand前端技术栈

**状态**: 已接受

**背景**: 需要组件化UI、高效状态管理、TypeScript支持。

**决策**: React 18 + Zustand + React Query组合。

**后果**:
- ✅ 开发效率高
- ✅ 状态管理简洁
- ✅ 服务端状态处理优秀
- ❌ 需要合理设计状态分层

### ADR-005: 采用事件驱动架构处理模拟事件

**状态**: 已接受

**背景**: 模拟系统产生大量事件，需要解耦处理、支持流式分析。

**决策**: 采用RabbitMQ作为事件总线，支持发布/订阅和队列模式。

**后果**:
- ✅ 系统解耦
- ✅ 削峰填谷
- ✅ 支持复杂事件处理
- ❌ 消息顺序保证复杂
- ❌ 需要处理消息丢失

---

## 附录

### A. 技术栈版本锁定

```json
{
  "frontend": {
    "react": "^18.2.0",
    "typescript": "^5.3.0",
    "antd": "^5.12.0",
    "zustand": "^4.4.0",
    "@tanstack/react-query": "^5.8.0",
    "d3": "^7.8.0",
    "echarts": "^5.4.0",
    "cytoscape": "^3.26.0",
    "vite": "^5.0.0"
  },
  "backend": {
    "@nestjs/core": "^10.3.0",
    "typescript": "^5.3.0",
    "typeorm": "^0.3.17",
    "neo4j-driver": "^5.15.0",
    "ioredis": "^5.3.0",
    "rabbitmq": "^3.12.0",
    "prom-client": "^15.1.0"
  },
  "infrastructure": {
    "postgresql": "16.1",
    "neo4j": "5.14.0",
    "redis": "7.2.0",
    "elasticsearch": "8.11.0",
    "kong": "3.5.0",
    "kubernetes": "1.28.0"
  }
}
```

### B. 架构图绘制工具

- **C4 Model**: 系统上下文、容器、组件图
- **Mermaid**: 流程图、时序图
- **Draw.io**: 详细架构图
- **PlantUML**: 类图、部署图

### C. 参考资料

1. [NestJS官方文档](https://docs.nestjs.com/)
2. [React官方文档](https://react.dev/)
3. [Neo4j图数据库设计](https://neo4j.com/developer/guide-data-modeling/)
4. [微服务设计模式](https://microservices.io/patterns/)
5. [事件驱动架构](https://martinfowler.com/articles/201701-event-driven.html)
